{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="mt-4">
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-3 text-primary"><strong>Company Information</strong></h5>
                {% if staff.staff_pix %}
                <img src="{{ staff.staff_pix.url }}" class="img-fluid rounded-circle" alt="Staff Picture" style="width: 100px; height: 100px; border-radius: 50%;">
                {% endif %}
            </div>
            <form action="" method="POST" enctype="multipart/form-data"> 
                {% csrf_token %}
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <label for="staffno" class="form-label">Staff Number</label>
                        <input type="text" class="form-control" id="staffno" name="staffno" value="{{ staff.staffno }}" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="job_title" class="form-label">Job Title</label>
                        <input type="text" class="form-control" id="job_title" name="job_title" value="{{ company_info.job_title }}" required>
                    </div>
                    <div class="col-md-4">
                        <label for="job_description" class="form-label">Job Description</label>
                        <input type="text" class="form-control" id="job_description" name="job_description" value="{{ company_info.job_description }}" required>
                    </div>
                    <div class="col-md-4">
                        <label for="staff_cat" class="form-label">Staff Category</label>
                        <select id="staff_cat" name="staff_cat" class="form-select" required>
                            <option value="" disabled selected>N/A</option>
                            {% if staffcategory %} 
                                {% for sc in staffcategory %}
                                    <option value="{{ sc.id }}"
                                    {% if sc.id == company_info.staff_cat_id %} selected {% endif %}
                                    
                                    > {{ sc.category_name }} </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="contract" class="form-label">Contract Type</label>
                        <select id="contract" name="contract" class="form-select" required>
                            <option value="" disabled selected>N/A</option>
                            {% if contract %} 
                                {% for ct in contract %}
                                    <option value="{{ ct.id }}"
                                    {% if ct.id == company_info.contract_id %} selected {% endif %}
                                    
                                    > {{ ct.contract_type }} </option>
                                {% endfor %}
                            {% endif %}
                            
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="active_status" class="form-label">Employee Status</label>
                        <select id="active_status" name="active_status" class="form-select" required>
                            <option value="" disabled selected>N/A</option>
                            {% for key, value in STAFFSTATUS %}
                            <option value="{{ key }}" {% if key == company_info.active_status %} selected {% endif %}>{{ value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="doa" class="form-label">Date of Appointment</label>
                        <input type="date" class="form-control" id="doa" name="doa" value="{{ company_info.doa|date:'Y-m-d' }}" required>
                    </div>
                    <div class="col-md-4">
                        <label for="doe" class="form-label">Date of Expiration
                            <span id="duration" class="text-danger"></span>
                        </label>
                        <input type="date" class="form-control" id="doe" name="doe" value="{{ company_info.doe|date:'Y-m-d' }}" required>
                    </div>
                    <div class="col-md-4">
                        <label for="renewal" class="form-label">Renewal</label>
                        <input type="date" class="form-control" id="renewal" name="renewal" value="{{ company_info.renewal|date:'Y-m-d' }}" required>
                    </div>
                    <div class="col-md-4">
                        <label for="sch_fac_dir" class="form-label">School/Faculty</label>
                        <select id="sch_fac_dir" name="sch_fac_dir" class="form-select" required>
                            <option value="" disabled selected>N/A</option>
                            {% if school_faculty %} 
                                {% for sch_fac in school_faculty %}
                                    <option value="{{ sch_fac.id }}"
                                    {% if sch_fac.id == company_info.sch_fac_id %} selected {% endif %}               
                                    > {{ sch_fac.sch_fac_name }} </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="dept" class="form-label">Department</label>
                        <select id="dept" name="dept" class="form-select">
                            <option value="" disabled selected>N/A</option>
                            {% if department %}
                                {% for dept in department %}
                                <option value="{{ dept.id }}"
                                {% if dept.id == company_info.dept_id %} selected {% endif %}
                                > {{ dept.dept_long_name }} </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="directorate" class="form-label">Directorate</label>
                        <select id="directorate" name="directorate" class="form-select">
                            <option value="" disabled selected>N/A</option>
                            {% if directorate %}
                                {% for dir in directorate %}
                                <option value="{{ dir.id }}"
                                {% if dir.id == company_info.directorate_id %} selected {% endif %}
                                > {{ dir.direct_name }} </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="rank" class="form-label">Designation/Rank</label>
                        <input type="text" class="form-control" id="rank" name="rank" value="{{ company_info.rank }}">
                    </div>
                    <div class="col-md-4">
                        <label for="campus" class="form-label">Campus</label>
                        <select id="campus" name="campus" class="form-select" required>
                            <option value="" disabled selected>Select Campus</option>
                            {% for camp in campus %}
                            <option value="{{ camp }}" {% if camp.campus_name == company_info.campus %} selected {% endif %}>{{ camp }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="city" class="form-label">City</label>
                        <input type="text" class="form-control" id="city" name="city" value="{{ company_info.city }}">
                    </div>
                    <div class="col-md-4">
                        <label for="email" class="form-label">Official Email</label>
                        <input type="email" class="form-control" id="email" name="email" value="{{ company_info.email }}">
                    </div>
                    <div class="col-md-4">
                        <label for="salary" class="form-label">Salary</label>
                        <input type="text" class="form-control" id="salary" name="salary" value="{{ company_info.salary }}">
                    </div>
                    <div class="col-md-4">
                        <label for="cost_center" class="form-label">Cost Center</label>
                        <select id="cost_center" name="cost_center" class="form-select" required>
                            <option value="" disabled selected>Select Cost Center</option>
                            {% if department %} 
                                {% for dept in department %}
                                    <option value="{{ dept.id }}"
                                    {% if dept.id == company_info.dept_id %} selected {% endif %}
                                    
                                    > {{ dept.dept_long_name }} </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                </div>
                <h5 class="mb-3 text-primary"><strong>Bank Information</strong></h5>
                <div class="row g-3">

                    
                    <div class="col-md-4">
                        <label for="bank_name" class="form-label">Bank Name</label>
                        <select id="bank_name" name="bank_name" class="form-select" required>
                            <option value="" disabled selected>Select Bank Name</option>
                            {% if bank_list %} 
                                {% for bn in bank_list %}
                                    <option value="{{ bn.id }}"
                                    {% if bn.id == pkno %} selected {% endif %}
                                    >{{ bn.bank_short_name }}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                   
                    <div class="col-md-4">
                        <label for="accno" class="form-label">Account Number</label>
                        <input type="text" class="form-control" id="accno" name="accno" value="{{ company_info.accno }}">
                    </div>
                    <div class="col-md-4">
                        <label for="bank_branch" class="form-label">Bank Branch</label>
                        <select id="bank_branch" name="bank_branch" class="form-select" required>
                            <option value="" disabled selected>Select Bank Branch</option>
                        </select>
                    </div>
                    
                    {% comment %} <div class="col-md-4">
                        <label for="bank_branch" class="form-label">Bank Branch</label>
                        <select id="bank_branch" name="bank_branch" class="form-select" required>
                            <option value="" disabled selected>Select Bank Branch</option>
                            {% if bankbranches %} 
                                {% for bb in bankbranches %}
                                    <option value="{{ bb.id }}"
                                    {% if bb.id == pkno %} selected {% endif %}
                                    
                                    > {{ bb.branch_name }} </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div> {% endcomment %}
                    <div class="col-md-4">
                        <label for="ssn_con" class="form-check-label">SSN Contribution</label>
                        <input type="checkbox" class="form-check-input" role="switch" id="ssn_con" name="ssn_con" value="yes" {% if company_info.ssn_con %} checked {% endif %}>
                    </div>
                    <div class="col-md-4">
                        <label for="pf_con" class="form-check-label">Provident Fund Contribution</label>
                        <input type="checkbox" class="form-check-input" id="pf_con" name="pf_con" value="yes" {% if company_info.pf_con %} checked {% endif %}>
                    </div>
                    
                </div> 

                <div class="d-flex justify-content-end mt-4">
                    <button type="submit" value="Add" class="btn btn-success me-2">Add</button>
                    <a href="{% url 'company-info' staff.staffno %}" class="btn btn-info">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>





<script type="text/javascript">

    // Duration Calulator
    document.addEventListener('DOMContentLoaded', function () {
        const doaInput = document.getElementById('doa');
        const doeInput = document.getElementById('doe');
        const durationSpan = document.getElementById('duration');
    
        function calculateDuration() {
            if (!doaInput || !doeInput) return; // Check if both inputs exist
    
            const doa = new Date(doaInput.value);
            const doe = new Date(doeInput.value);
    
            if (!isNaN(doa) && !isNaN(doe) && doaInput.value && doeInput.value) {
                let months = doe.getMonth() - doa.getMonth() + (12 * (doe.getFullYear() - doa.getFullYear()));
                let days = doe.getDate() - doa.getDate();
    
                if (days < 0) {
                    months -= 1;
                    days += new Date(doe.getFullYear(), doe.getMonth(), 0).getDate();
                }
    
                durationSpan.textContent = `(${months} months, ${days} days)`;
            } else {
                durationSpan.textContent = '';
            }
        }
    
        if (doaInput) {
            doaInput.addEventListener('change', calculateDuration);
        }
        doeInput.addEventListener('change', calculateDuration);
    
        // Initial calculation on page load
        calculateDuration();
    });




    document.addEventListener('DOMContentLoaded', function () {
        const bankNameSelect = document.getElementById('bank_name');
        const branchSelect = document.getElementById('bank_branch');
    
        if (bankNameSelect) {
            bankNameSelect.addEventListener('change', function() {
                const bankId = this.value;
    
                // Clear current options
                branchSelect.innerHTML = '<option value="" disabled selected>Select Bank Branch</option>';
    
                if (bankId) {
                    fetch(`/get_bank_branches/${bankId}/`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Fetched data:', data); // Add this to see the fetched data in the console
                        if (data.branches && data.branches.length > 0) {
                            data.branches.forEach(function(branch) {
                                const option = document.createElement('option');
                                option.value = branch.id;
                                option.text = branch.branch_name;
                                branchSelect.add(option);
                            });
                        } else {
                            console.log('No branches found.');
                        }
                    })
                    .catch(error => console.error('Error fetching branches:', error));
                }
            });
        }
    });
    

</script>



{% endblock %}
