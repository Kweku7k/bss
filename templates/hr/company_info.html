{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="mt-4">
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mt-3">
                <h5 class="mb-3 text-primary"><strong>Company Information for {{ staff.title }} {{ staff.fname }} {{ staff.lname }} ({{ staff.staffno }})</strong></h5>
                {% if staff.staff_pix %}
                <img src="{{ staff.staff_pix.url }}" class="img-fluid rounded-circle" alt="Staff Picture" style="width: 100px; height: 100px; border-radius: 50%;">
                {% endif %}
            </div>
            <form action="" method="POST" enctype="multipart/form-data"> 
                {% csrf_token %}
                <div class="row g-3 mb-4">
                    <input type="text" class="form-control" id="staffno" name="staffno" value="{{ staff.staffno }}" readonly hidden>

                    <div class="col-md-4">
                        <label for="job_title" class="form-label">Job Title</label>
                        <select id="job_title" name="job_title" class="form-select" required>
                            <option value="" selected>N/A</option>
                            {% if jobtitle %} 
                                {% for jt in jobtitle %}
                                    <option value="{{ jt.job_title }}" {% if jt.job_title == company_info.job_title %} selected {% endif %}> {{ jt.job_title }} </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>

                    {% comment %} <div class="col-md-4">
                        <label for="job_description" class="form-label">Job Description</label>
                        <input type="text" class="form-control" id="job_description" name="job_description" value="{{ company_info.job_description }}">
                    </div> {% endcomment %}
                    <div class="col-md-4">
                        <label for="staff_cat" class="form-label">Staff Category</label>
                        <select id="staff_cat" name="staff_cat" class="form-select" required>
                            <option value="" disabled selected>N/A</option>
                            {% if staffcategory %} 
                                {% for sc in staffcategory %}
                                    <option value="{{ sc.category_name }}"
                                    {% if sc.category_name == company_info.staff_cat %} selected {% endif %}
                                    
                                    > {{ sc.category_name }} </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="contract" class="form-label">Contract Type</label>
                        <select id="contract" name="contract" class="form-select" required>
                            <option value="" disabled selected>N/A</option>
                            {% if contract %} 
                                {% for ct in contract %}
                                    <option value="{{ ct.contract_type }}"
                                    {% if ct.contract_type == company_info.contract %} selected {% endif %}
                                    
                                    > {{ ct.contract_type }} </option>
                                {% endfor %}
                            {% endif %}
                            
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="active_status" class="form-label">Employee Status</label>
                        <select id="active_status" name="active_status" class="form-select" required>
                            <option value="" disabled selected>N/A</option>
                            {% for key, value in STAFFSTATUS %}
                            <option value="{{ key }}" {% if key == company_info.active_status %} selected {% endif %}>{{ value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="doa" class="form-label">Date of Appointment</label>
                        <input type="date" class="form-control" id="doa" name="doa" value="{{ company_info.doa|date:'Y-m-d' }}" required>
                    </div>
                    <div class="col-md-4">
                        <label for="doe" class="form-label">Date of Expiration
                            <span id="duration" class="text-danger"></span>
                        </label>
                        <input type="date" class="form-control" id="doe" name="doe" value="{{ company_info.doe|date:'Y-m-d' }}" required>
                    </div>
                    <div class="col-md-4">
                        <label for="renewal" class="form-label">Confirmation Date</label>
                        <input type="date" class="form-control" id="renewal" name="renewal" value="{{ company_info.renewal|date:'Y-m-d' }}">
                    </div>

                    <div class="col-md-4">
                        <label for="probation" class="form-label">Probatinary Period</label>
                        <input type="date" class="form-control" id="probation" name="probation" value="{{ company_info.probation|date:'Y-m-d' }}">
                    </div>

                    <div class="col-md-4">
                        <label for="sch_fac_dir" class="form-label">School/Faculty</label>
                        <select id="sch_fac_dir" name="sch_fac_dir" class="form-select">
                            <option value="" disabled selected>N/A</option>
                            {% if school_faculty %} 
                                {% for sch_fac in school_faculty %}
                                    <option value="{{ sch_fac }}" {% if sch_fac.sch_fac_name == company_info.sch_fac_dir %} selected {% endif %}> {{ sch_fac }} </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="dept" class="form-label">Department</label>
                        <select id="dept" name="dept" class="form-select">
                            <option value="" disabled selected>N/A</option>
                            {% if departments %}
                                {% for dept in departments %}
                                    <option value="{{ dept }}" {% if dept.dept_long_name == company_info.dept %} selected {% endif %}> {{ dept }} </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="directorate" class="form-label">Directorate</label>
                        <select id="directorate" name="directorate" class="form-select">
                            <option value=""  selected>N/A</option>
                            {% if directorate %}
                                {% for dir in directorate %}
                                <option value="{{ dir }}" {% if dir.direct_name == company_info.directorate %} selected {% endif %}> {{ dir }} </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>

                    
                    <div class="col-md-4">
                        <label for="rank" class="form-label">Designation/Rank</label>
                        <input type="text" class="form-control" id="rank" name="rank" value="{{ company_info.rank }}">
                    </div>
                    <div class="col-md-4">
                        <label for="campus" class="form-label">Campus</label>
                        <select id="campus" name="campus" class="form-select">
                            <option value="" disabled selected>Select Campus</option>
                            {% for camp in campus %}
                            <option value="{{ camp }}" {% if camp.campus_name == company_info.campus %} selected {% endif %}>{{ camp }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="city" class="form-label">City</label>
                        <input type="text" class="form-control" id="city" name="city" value="{{ company_info.city }}">
                    </div>
                    <div class="col-md-4">
                        <label for="email" class="form-label">Official Email</label>
                        <input type="email" class="form-control" id="email" name="email" value="{{ company_info.email }}">
                    </div>
                    <div class="col-md-4">
                        <label for="salary" class="form-label">Salary Scale</label>
                        <input type="text" class="form-control" id="salary" name="salary" value="{{ company_info.salary }}">
                    </div>

                    <div class="col-md-4">
                        <label for="pte" class="form-label">Point of Entry in Salary Scale</label>
                        <input type="text" class="form-control" id="pte" name="pte" value="{{ company_info.pte }}">
                    </div>
                    <div class="col-md-4">
                        <label for="cost_center" class="form-label">Cost Center</label>
                        <select id="cost_center" name="cost_center" class="form-select" >
                            <option value="" selected>Select</option>
                            {% if departments %} 
                                {% for dt in departments %}
                                    <option value="{{ dt }}" {% if dt.dept_long_name == company_info.cost_center %} selected {% endif %} > {{ dt }} </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                </div>
                <h5 class="mb-3 text-primary"><strong>Bank Information</strong></h5>
                <div class="row g-3">

                    <div class="col-md-4">
                        <label for="bank_name" class="form-label">Bank Name</label>
                        <select id="bank_name" name="bank_name" class="form-select">
                            <option value="">Select Bank Name</option>
                            {% if bank_list %} 
                                {% for bn in bank_list %}
                                    <option value="{{ bn }}" {% if bn.bank_short_name == company_info.bank_name %} selected {% endif %}>{{ bn }}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label for="accno" class="form-label">Account Number</label>
                        <input type="text" class="form-control" id="accno" name="accno" value="{{ company_info.accno }}">
                    </div>

                    <div class="col-md-4">
                        <label for="acc_name" class="form-label">Account Name</label>
                        <input type="text" class="form-control" id="acc_name" name="acc_name" value="{{ company_info.acc_name }}">
                    </div>
                    
                    <div class="col-md-4">
                        <label for="bank_branch" class="form-label">Bank Branch</label>
                        <select id="bank_branch" name="bank_branch" class="form-select">
                            <option value="">Select Bank Branch</option>
                            {% if bank_branches %}
                                {% for bb in bank_branches %}
                                    <option value="{{ bb }}" {% if bb.branch_name == company_info.bank_branch %} selected {% endif %}> {{ bb }}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    
                    
                    <div class="col-md-4">
                        <label for="ssn_con" class="form-check-label">SSN Contribution</label>
                        <input type="checkbox" class="form-check-input" role="switch" id="ssn_con" name="ssn_con" value="yes" {% if company_info.ssn_con %} checked {% endif %}>
                    </div>
                    <div class="col-md-4">
                        <label for="pf_con" class="form-check-label">Provident Fund Contribution</label>
                        <input type="checkbox" class="form-check-input" id="pf_con" name="pf_con" value="yes" {% if company_info.pf_con %} checked {% endif %}>
                    </div>
                    
                </div> 

                <div class="d-flex justify-content-end mt-4">
                    <a href="{% url 'company-info' staff.staffno %}" class="btn btn-danger me-2">Cancel</a>
                    <input type="submit" value="{% if company_info %}Update{% else %}Submit{% endif %}" class="btn btn-sm btn-success">
                </div>
            </form>
        </div>
    </div>
</div>





<script type="text/javascript">

    // Duration Calulator
    document.addEventListener('DOMContentLoaded', function () {
        const doaInput = document.getElementById('doa');
        const doeInput = document.getElementById('doe');
        const durationSpan = document.getElementById('duration');
    
        function calculateDuration() {
            if (!doaInput || !doeInput) return; // Check if both inputs exist
    
            const doa = new Date(doaInput.value);
            const doe = new Date(doeInput.value);
    
            if (!isNaN(doa) && !isNaN(doe) && doaInput.value && doeInput.value) {
                let months = doe.getMonth() - doa.getMonth() + (12 * (doe.getFullYear() - doa.getFullYear()));
                let days = doe.getDate() - doa.getDate();
    
                if (days < 0) {
                    months -= 1;
                    days += new Date(doe.getFullYear(), doe.getMonth(), 0).getDate();
                }
    
                durationSpan.textContent = `(${months} months, ${days} days)`;
            } else {
                durationSpan.textContent = '';
            }
        }
    
        if (doaInput) {
            doaInput.addEventListener('change', calculateDuration);
        }
        doeInput.addEventListener('change', calculateDuration);
    
        // Initial calculation on page load
        calculateDuration();
    });



    // Populate bank branch based on selected bank name 

    document.addEventListener('DOMContentLoaded', function () {
        const bankNameSelect = document.getElementById('bank_name');
        const branchSelect = document.getElementById('bank_branch');
    
        // Event listener for bank selection
        bankNameSelect.addEventListener('change', function() {
            const bankName = this.value;  // Get the selected bank name
    
            // Clear current branch options
            branchSelect.innerHTML = '<option value="" disabled selected>Select Bank Branch</option>';
    
            // Fetch branches based on the selected bank
            if (bankName) {
                fetch(`/get_bank_branches/${bankName}/`)  // Adjust this URL to match your route
                .then(response => response.json())
                .then(data => {
                    if (data.branches.length > 0) {
                        data.branches.forEach(branch => {
                            const option = document.createElement('option');
                            option.value = branch.branch_name;  // Use branch name as the value
                            option.text = branch.branch_name;
                            branchSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Error fetching branches:', error));
            }
        });
    });
    


    // Populate Department based on selected School or Faculty 
    document.addEventListener('DOMContentLoaded', function () {
        const schoolFacultySelect = document.getElementById('sch_fac_dir');
        const departmentSelect = document.getElementById('dept');
    
        // Event listener for school/faculty selection
        schoolFacultySelect.addEventListener('change', function() {
            const schFacName = this.value;
    
            // Clear current department options
            departmentSelect.innerHTML = '<option value="" disabled selected>Select Department</option>';
    
            // Fetch departments based on the selected school/faculty
            if (schFacName) {
                fetch(`/get_departments/${schFacName}/`)  // Adjust this URL to match your route
                .then(response => response.json())
                .then(data => {
                    if (data.departments.length > 0) {
                        data.departments.forEach(dept => {
                            const option = document.createElement('option');
                            option.value = dept.dept_long_name;
                            option.text = dept.dept_long_name;
                            departmentSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Error fetching departments:', error));
            }
        });
    });

</script>



{% endblock %}
