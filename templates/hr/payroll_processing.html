{% extends "base.html" %} 
{% load static %}
{% block content %}

<style>
.payslips-container {
    margin-top: 2rem;
}

.payslip-card {
    page-break-inside: avoid;
    margin-bottom: 2rem !important;
}

.payslip-card .card {
    border: 1px solid #e9ecef;
    border-radius: 0.5rem;
}

.payslip-card .card-body {
    padding: 1.5rem;
}

@media print {
    .payslip-card {
        page-break-after: always;
        margin-bottom: 0 !important;
    }
}
</style>


<div class="container mt-5">
    {% if messages %}
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            {% for message in messages %}
            <div id="toast{{ forloop.counter }}" class="toast show bg-{{ message.tags }}" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="10000">
                <div class="toast-header text-white bg-{{ message.tags }}">
                    <strong class="me-auto">{{ message.tags|title }}</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body text-white">
                    {{ message }}
                </div>
            </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="row">
        {% comment %} <div class="col-md-3 mt-4">
            {% include "partials/_sidebar.html" %} 
        </div> {% endcomment %}

        <div class="col-md-12">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-3 fw-bold">ðŸ“… Process Monthly Payroll</h4>
                        
                        {% if payrolls %}
                            <form method="get" id="exportForm" class="d-flex align-items-center gap-2">
                                <input type="hidden" name="month" value="{{ selected_month }}">
                                <input type="hidden" name="year" value="{{ selected_year }}">
        
                                <label for="format" class="form-label mb-0">Export</label>
                                <select name="format" id="format" class="form-select form-select-sm" style="width: auto;" required>
                                    <option value="">Select format</option>
                                    <option value="pdf">PDF</option>
                                    <option value="excel">Excel</option>
                                </select>
                                <button type="submit" class="btn btn-sm btn-success">Download</button>
                            </form>
                        {% endif %}
                    </div>
                    <form method="get" id="payrollForm" class="row g-2 mb-4">
                        <div class="col">
                            <label for="month" class="form-label">Month</label>
                            <select name="month" id="month" class="form-control" required>
                                <option value="">Select</option>
                                <option value="1" {% if selected_month == '1' %}selected{% endif %}>January</option>
                                <option value="2" {% if selected_month == '2' %}selected{% endif %}>February</option>
                                <option value="3" {% if selected_month == '3' %}selected{% endif %}>March</option>
                                <option value="4" {% if selected_month == '4' %}selected{% endif %}>April</option>
                                <option value="5" {% if selected_month == '5' %}selected{% endif %}>May</option>
                                <option value="6" {% if selected_month == '6' %}selected{% endif %}>June</option>
                                <option value="7" {% if selected_month == '7' %}selected{% endif %}>July</option>
                                <option value="8" {% if selected_month == '8' %}selected{% endif %}>August</option>
                                <option value="9" {% if selected_month == '9' %}selected{% endif %}>September</option>
                                <option value="10" {% if selected_month == '10' %}selected{% endif %}>October</option>
                                <option value="11" {% if selected_month == '11' %}selected{% endif %}>November</option>
                                <option value="12" {% if selected_month == '12' %}selected{% endif %}>December</option>
                            </select>
                        </div>

                        <div class="col">
                            <label for="year" class="form-label">Year</label>
                            <select name="year" id="year" class="form-control" required>
                                <option value="">Select</option>
                                <option value="2025" {% if selected_year == '2025' %}selected{% endif %}>2025</option>
                                <option value="2026" {% if selected_year == '2026' %}selected{% endif %}>2026</option>
                                <option value="2027" {% if selected_year == '2027' %}selected{% endif %}>2027</option>
                                <option value="2028" {% if selected_year == '2028' %}selected{% endif %}>2028</option>
                                <option value="2029" {% if selected_year == '2029' %}selected{% endif %}>2029</option>
                                <option value="2030" {% if selected_year == '2030' %}selected{% endif %}>2030</option>
                            </select>
                        </div>

                        <div class="col d-flex align-items-end">
                             <button type="submit" class="btn btn-success" id="processBtn">
                                <span id="btnText">Process Payslips</span>
                                <span id="spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            </button>
                        </div>
                    
                    </form>
                </div>
            </div>

            {% if payrolls %}
                <div class="payslips-container">
                    <h5 class="mb-3 text-primary">Generated Payslips ({{ payrolls|length }} staff)</h5>
                    {% for payroll_data in payrolls %}
                        <div class="payslip-card mb-4">
                            <div class="card shadow border-0 p-3">
                                <div class="card-body">
                                    <div class="text-center mb-4">
                                        <img src="/media/images/fav.png" alt="Logo" width="80">
                                        <h3 class="fw-bold text-uppercase">Central University</h3>
                                        <h5 class="text-muted">Payslip for {{ payroll_data.month }}</h5>
                                    </div>

                            <hr/>
                            <div class="row">
                                <div class="col-md-4">
                                    <p><strong>Name:</strong> {{ payroll_data.staff.title }} {{ payroll_data.staff.fname }} {{ payroll_data.staff.lname }} {{ payroll_data.staff.middlenames }}</p>
                                    <p><strong>Employee ID:</strong> {{ payroll_data.staff.staffno }}</p>                    
                                </div>
                                <div class="col-md-4">
                                    <p><strong>SS No.:</strong> {{ payroll_data.staff.ssnitno|default:'' }}</p>
                                    <p><strong>Job Title:</strong> {{ payroll_data.company_info.job_title|default:'' }}</p>
                                </div>
                                <div class="col-md-4">
                                    <p><strong>Grade:</strong> {{ payroll_data.company_info.job_title|default:'' }}</p>
                                    <p><strong>Notch:</strong> {{ payroll_data.company_info.notch|default:'' }}</p>                
                                </div>
                                <div class="col-md-4">
                                    <p><strong>Bank:</strong> {{ payroll_data.company_info.bank_name|default:'' }}</p>
                                    <p><strong>Bank Branch:</strong> {{ payroll_data.company_info.bank_branch|default:'' }}</p>
                                </div>
                                <div class="col-md-4">
                                    <p><strong>Bank A/C No:</strong> {{ payroll_data.company_info.accno|default:'' }}</p>
                                    <p><strong>Email Address:</strong> {{ payroll_data.company_info.email|default:'' }}</p>
                                </div>
                                <div class="col-md-4">
                                    <p><strong>Dept. (OU):</strong> 
                                        {% if payroll_data.company_info.dept and payroll_data.company_info.directorate %}
                                            {{ payroll_data.company_info.dept }} - {{ payroll_data.company_info.directorate }}
                                        {% elif payroll_data.company_info.dept %}
                                            {{ payroll_data.company_info.dept }}
                                        {% elif payroll_data.company_info.directorate %}
                                            {{ payroll_data.company_info.directorate }}
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="col-md-4">
                                    <p><strong>Cost Center:</strong> {{ payroll_data.company_info.cost_center|default:'' }}</p>                
                                </div>
                            </div>

                            <hr>
                            <div class="row">
                                <div class="col-md-3">
                                <p><strong>Basic Salary:</strong><span class="text-primary fw-bold">  GHâ‚µ{{ payroll_data.basic_salary }}<span/></p>
                                </div>
                                <div class="col-md-3">
                                    <p><strong>Gross Pay:</strong> GHâ‚µ{{ payroll_data.gross_salary }}</p>
                                </div>
                                <div class="col-md-3">
                                    <p><strong>Taxable Pay:</strong> GHâ‚µ{{ payroll_data.taxable_income }}</p>
                                </div>
                                <div class="col-md-3">
                                    <p><strong>Net Salary:</strong> <span class="text-success fw-bold">GHâ‚µ{{ payroll_data.net_salary }}</span></p>
                                </div>
                            </div>
                        
                            <div class="row">
                                <div class="col-md-4">
                                    <p><strong>SSF Contribution Employer:</strong> GHâ‚µ{{ payroll_data.employer_ssf }}</p>
                                </div>
                                <div class="col-md-4">
                                    <p><strong>PF Contribution Employer:</strong> GHâ‚µ{{ payroll_data.employer_pf }}</p>
                                </div>
                                <div class="col-md-4">
                                    <p><strong>Days:</strong> 28 days</p>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <h5 class="fw-bold">Allowances / Special Earnings</h5>
                                    <table class="table table-bordered table-striped">
                                        <thead>
                                            <tr>
                                                <th>Type</th>
                                                <th class="text-end">Amount (GHâ‚µ)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><strong>Basic Salary</strong></td>
                                                <td class="text-end">{{ payroll_data.basic_salary }}</td>
                                            </tr>
                                            {% for income in payroll_data.incomes %}
                                            <tr>
                                                <td>{{ income.income_type }} {% if income.percentage_on_basic %}({{ income.percentage_on_basic }}%){% endif %}</td>
                                                <td class="text-end">{{ income.entitled_amount }}</td>
                                            </tr>
                                            {% empty %}
                                            <tr><td colspan="2">No income records</td></tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    <p><strong>Total Allowances:</strong>GHâ‚µ{{ payroll_data.total_income }}</p>
                                </div>
                        
                                <div class="col-md-6">
                                    <h5 class="fw-bold">Deductions</h5>
                                    <table class="table table-bordered table-striped">
                                        <thead>
                                            <tr>
                                                <th>Type</th>
                                                <th class="text-end">Amount (GHâ‚µ)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% if payroll_data.income_tax and payroll_data.income_tax.tax %}
                                            <tr>
                                                <td>Income Tax</td>
                                                <td class="text-end">{{ payroll_data.income_tax.tax }}</td>
                                            </tr>
                                            {% endif %}
        
                                            {% if payroll_data.ssf_employee and payroll_data.ssf_employee.amount and payroll_data.ssf_employee.rate %}
                                            <tr>
                                                <td>Social Security ({{ payroll_data.ssf_employee.rate }}%)</td>
                                                <td class="text-end">{{ payroll_data.ssf_employee.amount }}</td>
                                            </tr>
                                            {% endif %}
        
                                            {% if payroll_data.pf_employee and payroll_data.pf_employee.rate and payroll_data.pf_employee.amount %}
                                            <tr>
                                                <td>PF Employee ({{ payroll_data.pf_employee.rate }}%)</td>
                                                <td class="text-end">{{ payroll_data.pf_employee.amount }}</td>
                                            </tr>
                                            {% endif %}
        
                                        
                                            {% if payroll_data.withholding_tax %}
                                            <tr>
                                                <td>Withholding Tax</td>
                                                <td class="text-end">{{ payroll_data.withholding_tax }}</td>
                                            </tr>
                                            {% endif %}
                                            {% if payroll_data.withholding_rent_tax %}
                                            <tr>
                                                <td>Withholding Rent Tax</td>
                                                <td class="text-end">{{ payroll_data.withholding_rent_tax }}</td>
                                            </tr>
                                            {% endif %}
                                            
                                            {% for deduction in payroll_data.deductions %}
                                            <tr>
                                                <td>{{ deduction.deduction_type }} {% if deduction.percentage_on_basic %}({{ deduction.percentage_on_basic }}%){% endif %}</td>
                                                <td class="text-end">{{ deduction.deductable_amount }}</td>
                                            </tr>
                                            {% empty %}
                                            <tr><td colspan="2">No deductions</td></tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    <p><strong>Total Deductions:</strong><span class="text-danger fw-bold"> GHâ‚µ{{ payroll_data.total_deduction }} </span></p>
                                </div>            
                            </div>
        
                            <div class="row mt-4">
                                {% if payroll_data.benefits_in_kind and payroll_data.benefits_in_kind.total_bik and payroll_data.benefits_in_kind.total_bik > 0 %}
                                    <div class="col-md-6">
                                        <h5 class="fw-bold">Benefits In Kind</h5>
                                        <table class="table table-bordered table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Type</th>
                                                    <th class="text-end">Amount (GHâ‚µ)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% if payroll_data.benefits_in_kind.rent_bik and payroll_data.benefits_in_kind.rent_bik > 0 %}
                                                <tr>
                                                    <td>Rent Element</td>
                                                    <td class="text-end">{{ payroll_data.benefits_in_kind.rent_bik }}</td>
                                                </tr>
                                                {% endif %}
        
                                                {% if payroll_data.benefits_in_kind.fuel_bik and payroll_data.benefits_in_kind.fuel_bik > 0 %}
                                                <tr>
                                                    <td>Fuel</td>
                                                    <td class="text-end">{{ payroll_data.benefits_in_kind.fuel_bik }}</td>
                                                </tr>
                                                {% endif %}
        
                                                {% if payroll_data.benefits_in_kind.vechile_bik and payroll_data.benefits_in_kind.vechile_bik > 0 %}
                                                <tr>
                                                    <td>Vechile Allowance</td>
                                                    <td class="text-end">{{ payroll_data.benefits_in_kind.vechile_bik }}</td>
                                                </tr>
                                                {% endif %}
        
                                                {% if payroll_data.benefits_in_kind.driver_bik and payroll_data.benefits_in_kind.driver_bik > 0 %}
                                                <tr>
                                                    <td>Drivers Allowance</td>
                                                    <td class="text-end">{{ payroll_data.benefits_in_kind.driver_bik }}</td>
                                                </tr>
                                                {% endif %}
        
                                                
                                            </tbody>
                                        </table>
        
                                        <p><strong>Total Benefits In Kind:</strong> GHâ‚µ{{ payroll_data.benefits_in_kind.total_bik }}</p>
                                    </div>
                                {% endif %}
        
                                {% if payroll_data.loan_details %}
                                    <div class="col-md-6">
                                        <h5 class="fw-bold">Loan Details</h5>
                                        <table class="table table-bordered table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Loan Type</th>
                                                    <th class="text-end">Principal (GHâ‚µ)</th>
                                                    <th class="text-end">Paid (GHâ‚µ)</th>
                                                    <th class="text-end">Outstanding (GHâ‚µ)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for loan in payroll_data.loan_details %}
                                                    <tr>
                                                        <td>{{ loan.type }}</td>
                                                        <td class="text-end">{{ loan.meta.principal_amount }}</td>
                                                        <td class="text-end">{{ loan.meta.amount_paid }}</td>
                                                        <td class="text-end">{{ loan.meta.outstanding_balance }}</td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% endif %}
                            </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-start">Please select a month to view all Staff Payslips.</p>
            {% endif %}
        </div>
    </div>
</div>  


<script>
    document.getElementById('payrollForm').addEventListener('submit', function() {
        const btn = document.getElementById('processBtn');
        const spinner = document.getElementById('spinner');
        const btnText = document.getElementById('btnText');
        
        btn.disabled = true;
        spinner.classList.remove('d-none');
        btnText.textContent = 'Processing...';
    });
</script>

{% endblock %}